# ===========================================
# Zinnia Nginx é…ç½®
# ===========================================
# 
# éƒ¨ç½²æ¨¡å¼è¯´æ˜ï¼š
# 1. é¦–æ¬¡éƒ¨ç½²ï¼ˆæ—  SSLï¼‰ï¼šä½¿ç”¨ HTTP æ¨¡å¼è·å– Let's Encrypt è¯ä¹¦
# 2. ç”Ÿäº§ç¯å¢ƒï¼ˆæœ‰ SSLï¼‰ï¼šå¯ç”¨ HTTPS å¹¶å¼ºåˆ¶é‡å®šå‘
#
# åˆ‡æ¢æ–¹å¼ï¼š
# - é¦–æ¬¡éƒ¨ç½²ï¼šä¿æŒå½“å‰é…ç½®
# - è·å–è¯ä¹¦åï¼šå–æ¶ˆæ³¨é‡Š HTTPS server å—ï¼Œå¹¶å¯ç”¨ HTTP é‡å®šå‘
# ===========================================

# ä¸Šæ¸¸æœåŠ¡å™¨å®šä¹‰
upstream zinnia_backend {
    server zinnia:8080;
    keepalive 32;
}

# HTTP æœåŠ¡å™¨é…ç½®
server {
    listen 80;
    listen [::]:80;
    server_name _;

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼Œä¸ç»è¿‡é™æµï¼‰
    location /health {
        access_log off;
        proxy_pass http://zinnia_backend/health;
        proxy_set_header Host $host;
    }

    # ACME è¯ä¹¦éªŒè¯ï¼ˆLet's Encryptï¼‰- certbot webroot æ¨¡å¼
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # ===========================================
    # ğŸ”’ å¯ç”¨ HTTPS åï¼Œå–æ¶ˆä¸‹æ–¹æ³¨é‡Šä»¥å¼ºåˆ¶é‡å®šå‘
    # ===========================================
    # location / {
    #     return 301 https://$host$request_uri;
    # }
    # ===========================================

    # ===========================================
    # ğŸ“ æœªå¯ç”¨ HTTPS æ—¶çš„ä¸´æ—¶é…ç½®ï¼ˆè·å–è¯ä¹¦å‰ä½¿ç”¨ï¼‰
    # ===========================================
    location / {
        # é™æµ
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;

        proxy_pass http://zinnia_backend;
        proxy_http_version 1.1;
        
        # ä»£ç†å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # WebSocket æ”¯æŒ
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ç‰¹æ®Šé™æµï¼šè®¤è¯ç›¸å…³æ¥å£
    location ~ ^/api/v1/(auth|users/login|users/register) {
        limit_req zone=login_limit burst=3 nodelay;
        
        proxy_pass http://zinnia_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    # ===========================================
}

# ===========================================
# ğŸ”’ HTTPS æœåŠ¡å™¨é…ç½®
# ===========================================
# è·å– SSL è¯ä¹¦åï¼š
# 1. å–æ¶ˆæ³¨é‡Šä¸‹æ–¹æ•´ä¸ª server å—
# 2. å°† your-domain.com æ›¿æ¢ä¸ºå®é™…åŸŸå
# 3. å¯ç”¨ä¸Šæ–¹ HTTP å—ä¸­çš„é‡å®šå‘
# 4. æ³¨é‡Šæ‰ HTTP å—ä¸­çš„ä¸´æ—¶ location / é…ç½®
# 5. é‡è½½ nginx: docker exec zinnia-nginx nginx -s reload
# ===========================================

# server {
#     listen 443 ssl;
#     listen [::]:443 ssl;
#     http2 on;
#     server_name your-domain.com;
#
#     # SSL è¯ä¹¦è·¯å¾„ï¼ˆç”± certbot è‡ªåŠ¨ç®¡ç†ï¼‰
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     ssl_trusted_certificate /etc/letsencrypt/live/your-domain.com/chain.pem;
#
#     # SSL å®‰å…¨é…ç½®ï¼ˆMozilla Modern é…ç½®ï¼‰
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#     
#     # SSL ä¼šè¯ç¼“å­˜
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 1d;
#     ssl_session_tickets off;
#     
#     # OCSP Stapling
#     ssl_stapling on;
#     ssl_stapling_verify on;
#     resolver 8.8.8.8 8.8.4.4 valid=300s;
#     resolver_timeout 5s;
#
#     # å®‰å…¨å“åº”å¤´
#     add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
#     add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
#
#     # å¥åº·æ£€æŸ¥
#     location /health {
#         access_log off;
#         proxy_pass http://zinnia_backend/health;
#         proxy_set_header Host $host;
#     }
#
#     # ä¸»è¦ API è·¯ç”±
#     location / {
#         limit_req zone=api_limit burst=20 nodelay;
#         limit_conn conn_limit 10;
#
#         proxy_pass http://zinnia_backend;
#         proxy_http_version 1.1;
#         
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Host $host;
#         
#         # WebSocket æ”¯æŒ
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#         
#         proxy_buffering off;
#         proxy_request_buffering off;
#     }
#
#     # è®¤è¯æ¥å£ç‰¹æ®Šé™æµ
#     location ~ ^/api/v1/(auth|users/login|users/register) {
#         limit_req zone=login_limit burst=3 nodelay;
#         
#         proxy_pass http://zinnia_backend;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
