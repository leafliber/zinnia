# è®¾å¤‡è®¿é—®ä»¤ç‰Œå®‰å…¨åˆ†æžæŠ¥å‘Š

> æ–°å¢žåŠŸèƒ½ï¼šè®¾å¤‡è®¿é—®ä»¤ç‰Œç³»ç»Ÿã€å…¼å®¹æ¨¡å¼ URL å‚æ•°è®¤è¯ã€å¼ºåˆ¶ç”¨æˆ·è®¾å¤‡ç»‘å®š

---

## ä¸€ã€æ–°å¢žåŠŸèƒ½æ¦‚è¿°

### 1.1 è®¾å¤‡è®¿é—®ä»¤ç‰Œï¼ˆDevice Access Tokenï¼‰

- æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æœ‰æ•ˆæœŸï¼ˆ1-8760å°æ—¶ï¼‰
- ç»†ç²’åº¦æƒé™æŽ§åˆ¶ï¼ˆread/write/allï¼‰
- IP ç™½åå•é™åˆ¶
- è¯·æ±‚é¢‘çŽ‡é™åˆ¶
- ä»¤ç‰ŒåŠé”€ä¸Žæ‰¹é‡åŠé”€

### 1.2 å…¼å®¹æ¨¡å¼ URL å‚æ•°è®¤è¯

- ä¸ºæ— æ³•è®¾ç½® HTTP è¯·æ±‚å¤´çš„è®¾å¤‡æä¾›æ”¯æŒ
- é€šè¿‡ URL æŸ¥è¯¢å‚æ•°ä¼ é€’è®¤è¯ä»¤ç‰Œå’Œæ•°æ®
- æ”¯æŒæžç®€æ¨¡å¼å‡å°‘å¸¦å®½æ¶ˆè€—

### 1.3 å¼ºåˆ¶ç”¨æˆ·è®¾å¤‡ç»‘å®š

- åˆ›å»ºè®¾å¤‡å¿…é¡»é€šè¿‡ç”¨æˆ·è®¤è¯
- æ‰€æœ‰è®¾å¤‡å¿…é¡»æœ‰æ˜Žç¡®çš„æ‰€æœ‰è€…

---

## äºŒã€æ½œåœ¨å®‰å…¨é£Žé™©åˆ†æž

### 2.1 URL å‚æ•°ä¸­çš„ä»¤ç‰Œæ³„éœ² âš ï¸ **é«˜é£Žé™©**

**é—®é¢˜æè¿°**ï¼š
å…¼å®¹æ¨¡å¼ API å°†ä»¤ç‰Œæ”¾åœ¨ URL æŸ¥è¯¢å‚æ•°ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹æ³„éœ²é£Žé™©ï¼š
- Web æœåŠ¡å™¨è®¿é—®æ—¥å¿—è®°å½•å®Œæ•´ URL
- ä»£ç†æœåŠ¡å™¨/CDN æ—¥å¿—è®°å½•
- æµè§ˆå™¨åŽ†å²è®°å½•ï¼ˆå¦‚æžœç”¨äºŽæµ‹è¯•ï¼‰
- HTTP Referer å¤´æ³„éœ²ï¼ˆè·³è½¬åˆ°å…¶ä»–é¡µé¢æ—¶ï¼‰

**ç¼“è§£æŽªæ–½**ï¼ˆå·²å®žçŽ°/å»ºè®®ï¼‰ï¼š
- âœ… å…¼å®¹æ¨¡å¼ä»¤ç‰Œä¸Žä¸» API Key åˆ†ç¦»ï¼Œæƒé™å—é™
- âœ… æ”¯æŒä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼Œé™åˆ¶æ³„éœ²å½±å“èŒƒå›´
- âœ… æ”¯æŒ IP ç™½åå•ï¼Œé™åˆ¶ä»¤ç‰Œä½¿ç”¨æ¥æº
- âœ… æ”¯æŒéšæ—¶åŠé”€ä»¤ç‰Œ
- âš¡ å»ºè®®ï¼šç”Ÿäº§çŽ¯å¢ƒä¸­é…ç½® Web æœåŠ¡å™¨ä¸è®°å½•æŸ¥è¯¢å‚æ•°
- âš¡ å»ºè®®ï¼šä½¿ç”¨ HTTPS åŠ å¯†ä¼ è¾“
- âš¡ å»ºè®®ï¼šä¸ºå…¼å®¹æ¨¡å¼è®¾ç½®æ›´çŸ­çš„é»˜è®¤è¿‡æœŸæ—¶é—´

```nginx
# Nginx æ—¥å¿—é…ç½®ç¤ºä¾‹ - ç§»é™¤æ•æ„Ÿå‚æ•°
log_format safe_log '$remote_addr - $remote_user [$time_local] '
                    '"$request_method $uri" $status $body_bytes_sent';
```

### 2.2 ä»¤ç‰Œå“ˆå¸Œå­˜å‚¨ä¸ŽéªŒè¯

**å½“å‰å®žçŽ°**ï¼š
- âœ… ä½¿ç”¨ Argon2 ç®—æ³•å¯¹ä»¤ç‰Œè¿›è¡Œå“ˆå¸Œå­˜å‚¨
- âœ… æ•°æ®åº“åªå­˜å‚¨å“ˆå¸Œå€¼ï¼Œå®Œæ•´ä»¤ç‰Œä»…åœ¨åˆ›å»ºæ—¶è¿”å›žä¸€æ¬¡
- âœ… ä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨ (ring::rand::SystemRandom)

**éªŒè¯æµç¨‹å®‰å…¨æ€§**ï¼š
```
å®¢æˆ·ç«¯ä»¤ç‰Œ â†’ æå–å‰ç¼€æŸ¥æ‰¾ â†’ èŽ·å–å“ˆå¸Œ â†’ Argon2 éªŒè¯ â†’ é€šè¿‡/æ‹’ç»
```

è¿™ç§è®¾è®¡ç¡®ä¿å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç›´æŽ¥ä½¿ç”¨ä»¤ç‰Œã€‚

### 2.3 ä»¤ç‰Œå‰ç¼€æŸ¥æ‰¾çš„æ—¶åºæ”»å‡» âš ï¸ **ä½Žé£Žé™©**

**é—®é¢˜æè¿°**ï¼š
é€šè¿‡ä»¤ç‰Œå‰ç¼€æŸ¥æ‰¾æ•°æ®åº“è®°å½•ï¼Œç†è®ºä¸Šå¯èƒ½è¢«ç”¨äºŽæžšä¸¾æœ‰æ•ˆä»¤ç‰Œå‰ç¼€ã€‚

**ç¼“è§£æŽªæ–½**ï¼š
- âœ… ä»¤ç‰Œå‰ç¼€ä½¿ç”¨è¶³å¤Ÿé•¿åº¦ï¼ˆ12å­—ç¬¦éšæœº + å›ºå®šå‰ç¼€ï¼‰
- âœ… å‰ç¼€åŽè¿˜éœ€è¦é€šè¿‡å®Œæ•´å“ˆå¸ŒéªŒè¯
- âš¡ å»ºè®®ï¼šæ·»åŠ è¯·æ±‚é¢‘çŽ‡é™åˆ¶é˜²æ­¢æš´åŠ›æžšä¸¾

### 2.4 IP ç™½åå•ç»•è¿‡ âš ï¸ **ä¸­é£Žé™©**

**é—®é¢˜æè¿°**ï¼š
ä¾èµ– `X-Forwarded-For` å’Œ `X-Real-IP` å¤´èŽ·å–å®¢æˆ·ç«¯ IPï¼Œå¯èƒ½è¢«ä¼ªé€ ã€‚

**å½“å‰å®žçŽ°**ï¼š
```rust
// src/handlers/compat_handler.rs
fn get_client_ip(req: &HttpRequest) -> Option<String> {
    // å°è¯•ä»Ž X-Forwarded-For èŽ·å–
    if let Some(forwarded) = req.headers().get("X-Forwarded-For") {
        // ...
    }
}
```

**ç¼“è§£æŽªæ–½**ï¼š
- âš¡ å»ºè®®ï¼šä»…åœ¨å¯ä¿¡ä»£ç†åŽä¿¡ä»»è¿™äº›å¤´
- âš¡ å»ºè®®ï¼šé…ç½® Actix Web çš„ trusted proxies
- âš¡ å»ºè®®ï¼šåœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨åå‘ä»£ç†å¹¶é…ç½®æ­£ç¡®çš„å®¢æˆ·ç«¯ IP ä¼ é€’

```rust
// å»ºè®®çš„é…ç½®
App::new()
    .wrap(actix_web::middleware::from_fn(|req, srv| {
        // åªä¿¡ä»»æ¥è‡ªç‰¹å®šä»£ç†çš„ X-Forwarded-For
    }))
```

### 2.5 ä»¤ç‰Œæ•°é‡é™åˆ¶

**å½“å‰å®žçŽ°**ï¼š
- âœ… æ¯è®¾å¤‡æœ€å¤š 20 ä¸ªæœ‰æ•ˆä»¤ç‰Œ
- âœ… æ”¯æŒè¿‡æœŸä»¤ç‰Œè‡ªåŠ¨æ¸…ç†

**å»ºè®®**ï¼š
- å®šæœŸè¿è¡Œæ¸…ç†ä»»åŠ¡åˆ é™¤è¿‡æœŸ/åŠé”€çš„ä»¤ç‰Œ
- ç›‘æŽ§ä»¤ç‰Œåˆ›å»ºé¢‘çŽ‡ï¼Œé˜²æ­¢æ»¥ç”¨

### 2.6 å¼ºåˆ¶ç”¨æˆ·ç»‘å®šçš„å½±å“

**å˜æ›´**ï¼š
```rust
// ä¹‹å‰ï¼šè®¾å¤‡åˆ›å»ºå¯é€‰ç»‘å®šç”¨æˆ·
let owner_id = auth.and_then(|a| a.user_id);

// çŽ°åœ¨ï¼šå¼ºåˆ¶è¦æ±‚ç”¨æˆ·è®¤è¯
let owner_id = auth.user_id
    .ok_or_else(|| AppError::Unauthorized("åˆ›å»ºè®¾å¤‡éœ€è¦ç”¨æˆ·è®¤è¯".to_string()))?;
```

**å®‰å…¨æå‡**ï¼š
- âœ… æ‰€æœ‰è®¾å¤‡éƒ½æœ‰æ˜Žç¡®çš„è´£ä»»äºº
- âœ… é˜²æ­¢åŒ¿åè®¾å¤‡æ³¨å†Œ
- âœ… ä¾¿äºŽå®¡è®¡å’Œè¿½æº¯

---

## ä¸‰ã€å®‰å…¨å»ºè®®æ¸…å•

### 3.1 å¿…é¡»å®žæ–½ âœ…

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| ä»¤ç‰Œå“ˆå¸Œå­˜å‚¨ | âœ… å·²å®žçŽ° | ä½¿ç”¨ Argon2 |
| ä»¤ç‰Œè¿‡æœŸæ”¯æŒ | âœ… å·²å®žçŽ° | 1-8760å°æ—¶ |
| æƒé™åˆ†ç¦» | âœ… å·²å®žçŽ° | read/write/all |
| ä»¤ç‰ŒåŠé”€ | âœ… å·²å®žçŽ° | å•ä¸ª/æ‰¹é‡ |
| å¼ºåˆ¶ç”¨æˆ·ç»‘å®š | âœ… å·²å®žçŽ° | è®¾å¤‡å¿…é¡»æœ‰æ‰€æœ‰è€… |

### 3.2 å¼ºçƒˆå»ºè®® âš¡

| é¡¹ç›® | è¯´æ˜Ž |
|------|------|
| HTTPS å¼ºåˆ¶ | åœ¨ç”Ÿäº§çŽ¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ HTTPS |
| æ—¥å¿—è„±æ• | é…ç½® Web æœåŠ¡å™¨ä¸è®°å½• URL å‚æ•°ä¸­çš„ token |
| é¢‘çŽ‡é™åˆ¶ | ä¸ºå…¼å®¹æ¨¡å¼ API æ·»åŠ æ›´ä¸¥æ ¼çš„é¢‘çŽ‡é™åˆ¶ |
| å¯ä¿¡ä»£ç†é…ç½® | æ­£ç¡®é…ç½® IP èŽ·å–é€»è¾‘ï¼Œä»…ä¿¡ä»»å¯ä¿¡ä»£ç† |

### 3.3 å¯é€‰å¢žå¼º ðŸ’¡

| é¡¹ç›® | è¯´æ˜Ž |
|------|------|
| ä»¤ç‰Œä½¿ç”¨å‘Šè­¦ | å¼‚å¸¸ä½¿ç”¨æ¨¡å¼ï¼ˆæ–° IPã€é«˜é¢‘è®¿é—®ï¼‰å‘Šè­¦ |
| åœ°ç†ä½ç½®æ£€æµ‹ | åŸºäºŽ IP åœ°ç†ä½ç½®çš„å¼‚å¸¸æ£€æµ‹ |
| ä»¤ç‰Œç»‘å®šè®¾å¤‡æŒ‡çº¹ | é™¤ IP å¤–å¢žåŠ æ›´å¤šè®¾å¤‡æŒ‡çº¹éªŒè¯ |
| å®¡è®¡æ—¥å¿— | è®°å½•æ‰€æœ‰ä»¤ç‰Œæ“ä½œä¾›å®¡è®¡ |

---

## å››ã€è¿ç»´å»ºè®®

### 4.1 å®šæœŸæ¸…ç†ä»»åŠ¡

å»ºè®®æ·»åŠ å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸä»¤ç‰Œï¼š

```rust
// æ¯å¤©æ¸…ç† 30 å¤©å‰è¿‡æœŸ/åŠé”€çš„ä»¤ç‰Œ
device_token_repo.cleanup_expired(30).await?;
```

### 4.2 ç›‘æŽ§æŒ‡æ ‡

å»ºè®®ç›‘æŽ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
- ä»¤ç‰Œåˆ›å»º/åŠé”€é¢‘çŽ‡
- å…¼å®¹æ¨¡å¼ API è°ƒç”¨é‡
- ä»¤ç‰ŒéªŒè¯å¤±è´¥çŽ‡
- IP ç™½åå•æ‹¦æˆªæ¬¡æ•°

### 4.3 æ•°æ®åº“ç´¢å¼•

ç¡®ä¿ä»¥ä¸‹ç´¢å¼•å­˜åœ¨ä»¥ä¼˜åŒ–æ€§èƒ½ï¼š

```sql
-- å·²åœ¨è¿ç§»ä¸­åˆ›å»º
CREATE INDEX idx_device_access_tokens_prefix ON device_access_tokens(token_prefix);
CREATE INDEX idx_device_access_tokens_device_id ON device_access_tokens(device_id);
```

---

## äº”ã€æ€»ç»“

æ–°å¢žçš„è®¾å¤‡è®¿é—®ä»¤ç‰Œç³»ç»Ÿåœ¨å®‰å…¨æ€§è®¾è®¡ä¸Šéµå¾ªäº†ä»¥ä¸‹åŽŸåˆ™ï¼š

1. **æœ€å°æƒé™åŽŸåˆ™**ï¼šä»¤ç‰Œå¯é…ç½®ä¸ºä»…è¯»æˆ–ä»…å†™
2. **æœ‰é™ç”Ÿå‘½å‘¨æœŸ**ï¼šæ”¯æŒè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´
3. **å¯åŠé”€æ€§**ï¼šéšæ—¶å¯ä»¥åŠé”€ä»¤ç‰Œ
4. **è®¿é—®æŽ§åˆ¶**ï¼šIP ç™½åå•å’Œé¢‘çŽ‡é™åˆ¶
5. **æ•°æ®ä¿æŠ¤**ï¼šä»¤ç‰Œå“ˆå¸Œå­˜å‚¨ï¼Œä¸å¯é€†

å…¼å®¹æ¨¡å¼ URL å‚æ•°è®¤è¯æ˜¯ä¸ºç‰¹æ®Šè®¾å¤‡åœºæ™¯çš„å¦¥åï¼Œä½†é€šè¿‡ä¸Šè¿°ç¼“è§£æŽªæ–½å¯ä»¥å°†é£Žé™©æŽ§åˆ¶åœ¨å¯æŽ¥å—èŒƒå›´å†…ã€‚

---

> ðŸ“… **åˆ†æžæ—¥æœŸ**ï¼š2026-01-12  
> ðŸ“‹ **ç‰ˆæœ¬**ï¼š1.0
